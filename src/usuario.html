<!-- 
    usuario.html
    Autor: Sergi Sirvent Sempere
    Fecha: 11/2021
    Este archivo se encarga de contener el contenido de la página de perfil del usuario
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angle Corp</title>

    <!-- Links estilos-->
        <link rel="stylesheet" href="Assets/css/bootstrap.min.css">
        <!-- Css -->
        <link rel="stylesheet" href="Assets/css/cssGeneral.css" type="text/css">
        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;400&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+Antique:wght@300&display=swap" rel="stylesheet">
        
        <!-- Favicon -->
        <link rel="shortcut icon" href="Assets/images/LOGO.png">

    <!-- 
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    -->
    <script src="LogicaFake/comprobarAcceso.js"></script>
    <script src="LogicaFake/editarUsuario.js"></script>
    <script src="LogicaFake/publicarInfoPrivada.js"></script>
    <script src="LogicaFake/obtenerMedicionesConPeriodoPorUsuario.js"></script>
    <script>
        function cargarUsuario(){
			
		
			
            //console.log(sessionStorage.getItem("usuarioActivoNombre"))
            //console.log(document.getElementById("datoUsuarioNombre").innerText)
            console.log(sessionStorage.getItem("usuarioActivoFechaNacimiento"))

            //cargamos sus datos en la pagina de info
            document.getElementById("datoUsuarioNombre").innerText = sessionStorage.getItem("usuarioActivoNombre")
            document.getElementById("datoUsuarioApellidos").innerText = sessionStorage.getItem("usuarioActivoApellidos")
            document.getElementById("datoUsuarioMail").innerText = sessionStorage.getItem("usuarioActivoMail")
            document.getElementById("datoUsuarioEdad").innerText = sessionStorage.getItem("usuarioActivoFechaNacimiento")
            document.getElementById("datoUsuarioTeléfono").innerText = sessionStorage.getItem("usuarioActivoTelefono")


            //cargamos sus datos en el pop up de editar

            document.getElementById("inputNombreEditar").value = sessionStorage.getItem("usuarioActivoNombre")
            document.getElementById("inputApellidosEditar").value = sessionStorage.getItem("usuarioActivoApellidos")
            document.getElementById("inputCorreoEditar").value = sessionStorage.getItem("usuarioActivoMail")
            document.getElementById("inputEdadEditar").value = sessionStorage.getItem("usuarioActivoFechaNacimiento")
            document.getElementById("inputTelefonoEditar").value = sessionStorage.getItem("usuarioActivoTelefono")

            //console.log(document.getElementById("inputEdadEditar").value)
			
			//cambiamos el boton si es admin
			if(sessionStorage.getItem("usuarioActivoMail") == "admin@gmail.com"){
				var botonAdmin = document.getElementById("botonObtenerNodo");
				botonAdmin.innerHTML = 'Histórico de Mapas';
				var enlaceAdmin = document.getElementById("enlaceObtenerNodo");
				enlaceAdmin.href = "mapaSelectorGases.html";
			}
		
			
				
			
			 
		
        }

    </script>
    <script>
        function cerrarSesion(){
            obetenerMedicionesConPeriodoPorUsuario("dia",parseInt(sessionStorage.getItem("usuarioActivoId")),function (err,res){
                //caso en el que haya ido todo bien
                var arrayJSON = JSON.parse(res)//almaceno el resultado en un arrayJSON
                arrayJSON=arrayJSON.mediciones;
                prepararInfoPrivada(arrayJSON)

            })

        }
    </script>
    <script>
        function prepararInfoPrivada(mediciones){
            //preparamos la distancia recorrida
            let distanciaRecorrida = 0
            if (mediciones.length === 0){//si la lista esta vacia
                distanciaRecorrida = 0;
            }else{
                for (var i = 0;i<= mediciones.length-1;i++){
                    if (i+1 >= mediciones.length){
                        //no se hace nada ya que rebasa el indice
                    }else{
                        //calculamos la distancia en de las mediciones de la lista4
                        var R = 6371; // km
                        var dLat = toRad(mediciones[i+1].localizacion_lat)-toRad(mediciones[i].localizacion_lat);
                        var dLon = toRad(mediciones[i+1].localizacion_lon)-toRad(mediciones[i].localizacion_lon);
                        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(toRad(mediciones[i].localizacion_lat)) * Math.cos(toRad(mediciones[i+1].localizacion_lat)) *
                            Math.sin(dLon/2) * Math.sin(dLon/2);
                        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        var d = R * c;
                        distanciaRecorrida = distanciaRecorrida +d
                    }

                }

            }
            //preparamos los minutos activos
            var horaInicio = parseInt(sessionStorage.getItem("usuarioActivoTiempoInicio"))
            var horaActual = Date.now();
            var diferenciaDeHoras = horaActual-horaInicio
            var minutos = (diferenciaDeHoras * 0.0000166667).toFixed(2);//redondeamos

            //preparamos el json para enviar a la logica fake

            let json = crearJSONinfo(sessionStorage.getItem("usuarioActivoId"),
                sessionStorage.getItem("usuarioActivoId_Sensor"),
                sessionStorage.getItem("usuarioActivoTelefono"),
                distanciaRecorrida,
                sessionStorage.getItem("usuarioActivoNombre"),
                minutos)
            publicarInfoPrivada(function (err,res){

                    //redirigimos al login y borramos variable
                    sessionStorage.clear()
                    console.log("Todo ha ido bien")
                    window.location.href = "index.html";

            },json)//llamada a la logica fake




        }
    </script>
    <script>
        function toRad(Value) { /** Convierte valores numericos a radianes */ return Value * Math.PI / 180; }


    </script>
    <script>

        function onClickBotonGuardarCambios(){

            //console.log("se pulsa")
            //comprobar si el usuario quiere cambiar contraseña
            if (document.getElementById("checkBoxCambiarContra").checked){
                //comprobar que todos los campos estan llenos
                if (document.getElementById("inputNombreEditar").value === "" ||
                    document.getElementById("inputApellidosEditar").value === "" ||
                    document.getElementById("inputCorreoEditar").value === "" ||
                    document.getElementById("inputEdadEditar").value === "" ||
                    document.getElementById("inputTelefonoEditar").value === "" ||
                    document.getElementById("inputContrasenyaEditar").value === "" ||
                    document.getElementById("inputContrasenyaNuevaEditar").value === "" ||
                    document.getElementById("inputReContrasenyaNuevaEditar").value === ""){

                    alert("Debes rellenar todos los campos")
                }else{
                    //alert("adelante")

                    //comprobar que la nueva contraseña es diferente a la anterior
                    if(document.getElementById("inputContrasenyaEditar").value === document.getElementById("inputContrasenyaNuevaEditar").value){
                        alert("Si quieres cambiar la contraseña no debe coincidir con la antigua")
                    }else{
                        //comprobar si las nuevas contraseñas son diferentes
                        if(document.getElementById("inputContrasenyaNuevaEditar").value !== document.getElementById("inputReContrasenyaNuevaEditar").value){
                            alert("Las contraseñas nuevas deben coincidir")
                        }else{
                            if (document.getElementById("inputContrasenyaEditar").value !== sessionStorage.getItem("usuarioActivoPassword")){
                                //si la contraseña antigua no coincide con la contraseña del usuario
                                alert("Introduce correctamente tu contraseña antigua")
                            }else{
                                //caso correcto
                                let json = crearJSONUsuario(sessionStorage.getItem("usuarioActivoId"),
                                    document.getElementById("inputNombreEditar").value,
                                    document.getElementById("inputApellidosEditar").value,
                                    document.getElementById("inputCorreoEditar").value,
                                    document.getElementById("inputEdadEditar").value,
                                    document.getElementById("inputTelefonoEditar").value,
                                    document.getElementById("inputContrasenyaNuevaEditar").value,
									sessionStorage.getItem("usuarioActivoId_Sensor")
                                )
                                //llamamos a la logica fake
                                editarUsuario(function (err,res){
                                    if (res === "1"){
                                        alert("Cambios guardados correctamente")

                                        //cambiamos las variables de sesion con la contraseña nueva
                                        sessionStorage.setItem("usuarioActivoMail",document.getElementById("inputCorreoEditar").value)
                                        sessionStorage.setItem("usuarioActivoNombre",document.getElementById("inputNombreEditar").value)
                                        sessionStorage.setItem("usuarioActivoApellidos",document.getElementById("inputApellidosEditar").value)
                                        sessionStorage.setItem("usuarioActivoFechaNacimiento",document.getElementById("inputEdadEditar").value)
                                        sessionStorage.setItem("usuarioActivoTelefono",document.getElementById("inputTelefonoEditar").value)
                                        sessionStorage.setItem("usuarioActivoPassword",document.getElementById("inputContrasenyaNuevaEditar").value)

                                        //pintamos los datos del usuario en usuario.html y en el popup de editar
                                        cargarUsuario()
                                        //redirigir a usuario.html
                                        window.location.href = 'usuario.html'
                                    }else{
                                        alert("Algo ha fallado")
                                    }
                                },json)
                            }


                        }
                    }
                }
            }else{
                if (document.getElementById("inputNombreEditar").value === "" ||
                    document.getElementById("inputApellidosEditar").value === "" ||
                    document.getElementById("inputCorreoEditar").value === "" ||
                    document.getElementById("inputEdadEditar").value === "" ||
                    document.getElementById("inputTelefonoEditar").value === ""){

                    alert("Debes rellenar todos los campos")
                }else{
                    //alert("adelante")
                    //caso correcto
                    let json = crearJSONUsuario(sessionStorage.getItem("usuarioActivoId"),
                        document.getElementById("inputNombreEditar").value,
                        document.getElementById("inputApellidosEditar").value,
                        document.getElementById("inputCorreoEditar").value,
                        document.getElementById("inputEdadEditar").value,
                        document.getElementById("inputTelefonoEditar").value,
                        sessionStorage.getItem("usuarioActivoPassword"),
						sessionStorage.getItem("usuarioActivoId_Sensor")
                    )
                    //llamamos a la logica fake
                    editarUsuario(function (err,res){
                        if (res === "1"){
                            alert("Cambios guardados correctamente")
                            //cambiamos las variables de sesion sin la contraseña nueva
                            sessionStorage.setItem("usuarioActivoMail",document.getElementById("inputCorreoEditar").value)
                            sessionStorage.setItem("usuarioActivoNombre",document.getElementById("inputNombreEditar").value)
                            sessionStorage.setItem("usuarioActivoApellidos",document.getElementById("inputApellidosEditar").value)
                            sessionStorage.setItem("usuarioActivoFechaNacimiento",document.getElementById("inputEdadEditar").value)
                            sessionStorage.setItem("usuarioActivoTelefono",document.getElementById("inputTelefonoEditar").value)

                            //pintamos los datos del usuario en usuario.html y en el popup de editar
                            cargarUsuario()
                            //redirigir a usuario.html
                            window.location.href = 'usuario.html'
                        }else{
                            alert("Algo ha fallado")
                        }

                    },json)

                }
            }




            //hacer json con los campos
            //cambiar los datos del usuario y volver a cargar la pagina

            console.log(sessionStorage.getItem("usuarioActivoId"))
        }



    </script>
    <script>
        function toggleDivCambiarContra() {
            if (document.getElementById("divQuieroCambiarMiContrasenya").style.display == "inherit"){
                document.getElementById("divQuieroCambiarMiContrasenya").style.display = "none";
            }else{
                document.getElementById("divQuieroCambiarMiContrasenya").style.display = "inherit";
            }

            console.log(document.getElementById('checkBoxAutobusero').checked)
        }
    </script>
    <script>
        function crearJSONUsuario(id,nombre,apellidos,mail,fechaNacimiento,telefono,contrasenya,id_sensor){
            let json = {
                "id_usuario": id,
                "nombre": nombre,
                "apellidos": apellidos,
                "mail":mail,
                "fechaNacimiento": fechaNacimiento,
                "telefono":telefono,
                "password": contrasenya,
				"id_sensor":id_sensor
            };
            return json
        }
    </script>
    <script>
        function crearJSONinfo(idu,ids,telefono,distancia,nombre,minutos){
            let json = {
                "id_usuario" : idu,
                "id_sensor": ids,
                "telefono": telefono,
                "distancia_recorrida": distancia,
                "nombre": nombre,
                "minutos_activo":minutos,
            };
            return json
        }
    </script>

</head>
<body class="bodyUsuario" onload="cargarUsuario()">
    <header class="header">
        
        <!-- Logo --------------------------------------------------------------------->
        <a href="index.html"><img class="logo" src="Assets/images/LOGO.png" alt="Imagen del logo"></a>
        <!-- Nav --------------------------------------------------------------------->
        <nav class="navbar navbar-expand-lg navbar-light">

                  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                  </button>

                  <div class="collapse navbar-collapse" id="navbarSupportedContent">

                     <ul class="navbar-nav mr-auto">

                      <li class="nav-item">
                        <a class="nav-link" href="index.html">INICIO </a>
                      </li>

                      <li class="nav-item">
                        <a class="nav-link" href="mapa.html">MAPA</a>
                      </li>

                      <li class="nav-item">
                        <a class="nav-link" href="index.html#containerContaminantes">CONTAMINANTES</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="index.html#containerSobreNosotros">¿QUIÉNES SOMOS?</a>
                      </li>
                         <li class="nav-item">
                             <a class="nav-link" style="cursor: pointer" onclick="comprobarAcceso()" >MI PERFIL</a>
                         </li>

                    </ul>

                  </div>
            </nav>
          
      </header>
    <div class="container">
        
        <div class="container-usuario">
    
   
            <div class="containerUsuario">
        
                <div class="containerArribaUsuario">
                    <div class="containerImagenGrandeYCambios">
                    <img class="imagenGrandeUsuario" src="Assets/images/perfil.png" alt="Imagen Del Usuario">
                    
                    
                </div>
        
                <form class="formUsuario">
                    
                    <div class="containerTituloUsuario">
                    
                        <span class="tituloFormularioUsuario">
                            Mis datos
                        </span>
                    </div>
                        
                    
                    
                    <div class="containerDatosUsuario">
                        
                        <div class="containerLabelsDatosUsuario">
                            <div>
                                <img src="Assets/images/tarjeta-de-identificacion.png" alt="Imagen icono nombre">
                                <p>Nombre:</p>
                            </div>
                            <div>
                                <img src="Assets/images/tarjeta-de-identificacion.png" alt="Imagen icono apellidos">
                                <p>Apellidos:</p>
                            </div>
                            <div>
                                <img src="Assets/images/correo-electronico%20(2).png" alt="Imagen icono correo">
                                <p>Correo Electrónico:</p>
                            </div> 
                            <div>
                                <img src="Assets/images/calendario-semanal.png" alt="Imagen icono edad">
                                <p>Edad:</p>
                            </div>
                            <div>
                                <img src="Assets/images/telefono.png" alt="Imagen icono edad">
                                <p>Teléfono:</p>
                            </div>
                            
                        </div>
                        <div class="textosDatosUsuario">

                            <p id="datoUsuarioNombre">Manolo</p>
                            <p id="datoUsuarioApellidos">Castillo Vidal</p>
                            <p id="datoUsuarioMail">manoloete34@gmail.com</p>
                            <p id="datoUsuarioEdad">46</p>
                            <p id="datoUsuarioTeléfono">46</p>

                        </div>
                        
                        
                        
                    </div>
                    
                    
        
                </form>
                </div>
        
                <div class="containerUsuarioInferior">
                   <div>
                        <a href="#popupEditar">Editar Mi Perfil</a>
                        <a  onclick="cerrarSesion()" id="textoCerrarSesionUsuario">Cerrar Sesión</a>
                    </div>
                    <a href="index.html#quieroMiSensor" id="enlaceObtenerNodo"> <button id="botonObtenerNodo" class="btnObtenerNodoUsuario">Obtener Mi Nodo</button></a>
                   
                </div>
                
                
            </div>
            
        </div>

    </div>
    <div style="margin-top: 50px;" class="footer">

          <a href="http://www.upv.es/es"><img  id="logoUpvFooter" src="Assets/images/logoUPvBlanco.png" alt="logoUPVBlanco"></a>
          <div class="textosFooter">
              <p style="margin-left:2px">&copy; ANGLE CORP</p>
              <div style="border-left: 2px solid aliceblue;margin-left: 2px;margin: 5px;">|</div>
              <p>EPSG</p>
              <div style="border-left: 2px solid aliceblue;margin-left: 2px;margin: 5px;">|</div>
              <p><a href="mailto:anglecorp@epsg.upv.es">anglecorp@epsg.upv.es</a></p>
              <div style="border-left: 2px solid aliceblue;margin-left: 2px;margin: 5px;">|</div>
              <p>2021</p>


          </div>
          <a href="index.html"><img src="Assets/images/LOGO.png" alt="Logo de Angle Corp"></a>




       </div>

    <div id="popupEditar" class="overlay">

        <div id="popupBodyEditar">
            <div class="cabeceraPopUpEditar">
				
                <div>
                    <img src="Assets/images/lapiz.png" alt="Icono lapiz">
                    <h2>Editar Usuario</h2>
                </div>

                <a id="cerrarEditarUsuario" href="#"><img src="Assets/images/boton-de-cierre%20.png" alt="Imagen cerrar popUp"></a>

            </div>


            <div class="popupContentEditar">
                <div class="containerPopUpEditarIzquierda">
                    <!--Input de Nombre-->
                    <div class="inputLogin" data-validate = "Hace falta un nombre valido: ex@abc.xyz">

                        <img src="Assets/images/tarjeta-de-identificacion.png" alt="Imagen de sobre">
                        <input id="inputNombreEditar" class="inputTextoLogin" type="text" name="name" placeholder="Nombre">

                    </div>
                    <!--Input de Apellidos-->
                    <div  class="inputLogin" data-validate = "Apellidos válidos Requeridos">

                        <img src="Assets/images/tarjeta-de-identificacion.png" alt="Imagen tarjeta credito">
                        <input  id="inputApellidosEditar" class="inputTextoLogin" type="text" name="apellidos" placeholder="Apellidos">

                    </div>
                    <!--Input de Mail-->
                    <div  class="inputLogin" data-validate = "Edad válida Requerida">

                        <img src="Assets/images/correo-electronico%20(2).png" alt="Imagen calendario">
                        <input  id="inputCorreoEditar" class="inputTextoLogin" type="text" name="age" placeholder="Correo">

                    </div>
                    <!--Input de Edad-->
                    <div  class="inputLogin" data-validate = "Edad válida Requerida">

                        <img src="Assets/images/calendario-semanal.png" alt="Imagen calendario">
                        <input  id="inputEdadEditar" class="inputTextoLogin" type="date" name="age" placeholder="Edad">

                    </div>
                    <!--Input de telefono-->
                    <div  class="inputLogin" data-validate = "Contraseña válida Requerida">

                        <img src="Assets/images/telefono.png" alt="Imagen candado">
                        <input id="inputTelefonoEditar" class="inputTextoLogin" type="text" name="Rpass" placeholder="Numero de teléfono">

                    </div>
                </div>
                <div class="containerPopUpEditarDerecha">
                    <span  class="divCheckBoxCambiar" style="display: flex;flex-direction: row">
                                <p>¿Quieres cambiar tu contraseña?</p>
                        <!-- Rounded switch -->
                                <label style="margin-left: 10px" class="switch">
                                  <input id="checkBoxCambiarContra" onclick="toggleDivCambiarContra()" type="checkbox">
                                  <span class="slider round"></span>
                                </label>
                </span>

                    <div id="divQuieroCambiarMiContrasenya" style="display: none">
                        <!--Input de contraseña antigua-->
                        <div  class="inputLogin" data-validate = "Contraseña válida Requerida">

                            <img src="Assets/images/candado.png" alt="Imagen candado">
                            <input id="inputContrasenyaEditar" class="inputTextoLogin" type="password" name="pass" placeholder="Antigua Contraseña">

                        </div>
                        <!--Input de contraseña nueva-->
                        <div  class="inputLogin" data-validate = "Contraseña válida Requerida">

                            <img src="Assets/images/candado.png" alt="Imagen candado">
                            <input id="inputContrasenyaNuevaEditar" class="inputTextoLogin" type="password" name="pass" placeholder="Nueva Contraseña">

                        </div>
                        <!--Input de contraseña nueva repetir-->
                        <div  class="inputLogin" data-validate = "Contraseña válida Requerida">

                            <img src="Assets/images/candado.png" alt="Imagen candado">
                            <input id="inputReContrasenyaNuevaEditar" class="inputTextoLogin" type="password" name="pass" placeholder="Repite Nueva Contraseña">

                        </div>
                    </div>
                </div>
            </div>
            <button class="botonLogin" onclick="onClickBotonGuardarCambios()">Guardar Cambios</button>
        </div>

    </div>
    
</body>

</html>

